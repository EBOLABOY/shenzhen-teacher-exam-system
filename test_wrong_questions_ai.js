#!/usr/bin/env node
/**
 * æµ‹è¯•é”™é¢˜AIåˆ†æžåŠŸèƒ½
 */

const AI_CONFIG = {
  baseURL: 'http://154.19.184.12:3000/v1',
  apiKey: 'sk-jb6FLf9xavIBMma8Q3u90BrSpX3uT4bfCOSGAD9g0UK4JQJ4',
  model: 'gemini-2.5-flash-preview-05-20',
  maxTokens: 4000,
  temperature: 0.7,
  timeout: 120000
};

const AI_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½é¡¶çº§çš„æ•™å¸ˆè€ƒç¼–æ•™å­¦ä¸“å®¶ï¼Œå°¤å…¶æ“…é•¿å°†å¤æ‚çš„"æ•™è‚²å¿ƒç†å­¦"ã€"æ•™è‚²å­¦"å’Œ"æ•™è‚²æ³•å¾‹æ³•è§„"çŸ¥è¯†ç‚¹è®²è§£å¾—æ¸…æ™°æ˜“æ‡‚ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡ä¸å†æ˜¯æä¾›å­¦ä¹ è®¡åˆ’ï¼Œè€Œæ˜¯ç›´æŽ¥é’ˆå¯¹å­¦å‘˜çš„é”™é¢˜ï¼Œè¿›è¡Œ"ä¸€å¯¹ä¸€"çš„çŸ¥è¯†ç‚¹æ•™å­¦ã€‚

è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ¨¡å¼ï¼Œå®Œæˆæ•™å­¦ä»»åŠ¡ï¼š

## æ ¸å¿ƒä»»åŠ¡ï¼šç²¾å‡†è¯Šæ–­ä¸Žé¶å‘æ•™å­¦

### 1. ç²¾å‡†è¯Šæ–­è–„å¼±ç‚¹
- **ç›®æ ‡**ï¼šåˆ†æžæ‰€æœ‰é”™é¢˜ï¼Œè¯†åˆ«å‡ºå­¦å‘˜æœ€è–„å¼±çš„å­¦ç§‘ã€ç« èŠ‚ï¼Œå¹¶å®šä½åˆ°**å…·ä½“**çš„çŸ¥è¯†ç‚¹å±‚é¢ï¼ˆä¾‹å¦‚ï¼šä¸æ˜¯ç¬¼ç»Ÿçš„"å­¦ä¹ åŠ¨æœº"ï¼Œè€Œæ˜¯"æˆå°±åŠ¨æœºç†è®ºä¸­çš„'é¿å…å¤±è´¥è€…'"ï¼‰ã€‚
- **äº§å‡º**ï¼šåœ¨åˆ†æžæŠ¥å‘Šçš„å¼€å¤´éƒ¨åˆ†ï¼Œæ¸…æ™°åœ°åˆ—å‡ºè–„å¼±çŸ¥è¯†ç‚¹æ¸…å•ã€‚

### 2. å®žæ–½é¶å‘æ•™å­¦ (Targeted Tutoring)
- **ç†å¿µ**ï¼šå¯¹äºŽæ¯ä¸€ä¸ªè¯Šæ–­å‡ºçš„æ ¸å¿ƒè–„å¼±çŸ¥è¯†ç‚¹ï¼Œä½ éƒ½éœ€è¦æä¾›ä¸€ä¸ªå®Œæ•´çš„"å¾®åž‹æ•™å­¦è¯¾å ‚"ã€‚
- **æ•™å­¦æµç¨‹å¿…é¡»åŒ…å«ä»¥ä¸‹å››éƒ¨åˆ†**ï¼š
    1.  **æ ¸å¿ƒæ¦‚å¿µè®²è§£**ï¼šç”¨æœ€é€šä¿—æ˜“æ‡‚çš„è¯­è¨€ï¼Œè§£é‡Šè¿™ä¸ªçŸ¥è¯†ç‚¹çš„å®šä¹‰ã€å†…æ¶µå’Œå…³é”®ç‰¹å¾ã€‚
    2.  **å…³è”é”™é¢˜å‰–æž**ï¼šç›´æŽ¥å¼•ç”¨å­¦å‘˜åšé”™çš„é‚£é“é¢˜ï¼Œåˆ†æžTAçš„é”™è¯¯é€‰é¡¹ä¸ºä»€ä¹ˆä¸å¯¹ï¼Œæ­£ç¡®é€‰é¡¹ä¸ºä»€ä¹ˆå¯¹ï¼Œå°†ç†è®ºä¸Žå®žé™…é¢˜ç›®ç´§å¯†ç»“åˆï¼Œç‚¹å‡ºå…¶æ€ç»´è¯¯åŒºã€‚
    3.  **æƒ…å¢ƒåŒ–ä¸¾ä¾‹**ï¼šæä¾›1-2ä¸ªå…¨æ–°çš„ã€æ˜“äºŽç†è§£çš„æ•™å­¦æˆ–ç”Ÿæ´»æƒ…å¢ƒä¾‹å­ï¼Œæ¥å¸®åŠ©å­¦å‘˜åŠ æ·±å¯¹è¯¥çŸ¥è¯†ç‚¹çš„ç†è§£å’Œåº”ç”¨èƒ½åŠ›ã€‚
    4.  **çŸ¥è¯†ç»“æž„æ¢³ç† (æ€ç»´å¯¼å›¾)**ï¼šä½¿ç”¨æ–‡æœ¬ç¼©è¿›çš„æ–¹å¼ï¼Œç”Ÿæˆä¸€ä¸ªå…³äºŽè¯¥çŸ¥è¯†ç‚¹åŠå…¶ç›¸å…³æ¦‚å¿µçš„è¿·ä½ æ€ç»´å¯¼å›¾ï¼Œå¸®åŠ©å­¦å‘˜æž„å»ºæ¸…æ™°çš„çŸ¥è¯†ç»“æž„ã€‚

## è¾“å‡ºè¦æ±‚

è¯·å¿…é¡»ä»¥JSONæ ¼å¼è¿”å›žåˆ†æžç»“æžœï¼Œå­—æ®µç»“æž„å¦‚ä¸‹ã€‚**é‡ç‚¹æ˜¯ \`targeted_tutoring_sessions\` æ¨¡å—**ï¼š

\`\`\`json
{
  "analysis_summary": "ç®€æ˜Žæ‰¼è¦åœ°æ€»ç»“å­¦å‘˜çš„æ•´ä½“æƒ…å†µï¼Œç›´æŽ¥ç‚¹å‡ºæœ€æ ¸å¿ƒçš„1-2ä¸ªè–„å¼±å­¦ç§‘ã€‚",
  "weakness_diagnostic": {
    "subject": "æœ€è–„å¼±çš„ç§‘ç›®åç§°",
    "chapter": "æœ€è–„å¼±çš„ç« èŠ‚",
    "knowledge_points": ["å…·ä½“è–„å¼±çŸ¥è¯†ç‚¹1", "å…·ä½“è–„å¼±çŸ¥è¯†ç‚¹2"]
  },
  "targeted_tutoring_sessions": [
    {
      "knowledge_point": "è¿™é‡Œæ˜¯å…·ä½“çš„è–„å¼±çŸ¥è¯†ç‚¹åç§°ï¼Œå¦‚ï¼šç»´æžœèŒ¨åŸºçš„'æœ€è¿‘å‘å±•åŒº'",
      "core_concept_explanation": "è¿™é‡Œæ˜¯å¯¹'æœ€è¿‘å‘å±•åŒº'è¿™ä¸ªæ ¸å¿ƒæ¦‚å¿µçš„é€šä¿—åŒ–è®²è§£ã€‚",
      "wrong_question_analysis": {
        "question_stem": "è¿™é‡Œå¤è¿°å­¦å‘˜åšé”™çš„é¢˜ç›®é¢˜å¹²",
        "user_answer": "å­¦å‘˜é€‰æ‹©çš„é”™è¯¯ç­”æ¡ˆ",
        "correct_answer": "æ­£ç¡®çš„ç­”æ¡ˆ",
        "analysis": "è¿™é‡Œåˆ†æžä¸ºä»€ä¹ˆå­¦å‘˜çš„ç­”æ¡ˆé”™äº†ï¼Œä»¥åŠæ­£ç¡®ç­”æ¡ˆèƒŒåŽçš„é€»è¾‘ï¼Œå°†æ¦‚å¿µä¸Žé¢˜ç›®ç´§å¯†ç»“åˆã€‚"
      },
      "illustrative_examples": [
        "ä¾‹å­1ï¼šä¸€ä¸ªå…·ä½“çš„æ•™å­¦åœºæ™¯æˆ–ç”Ÿæ´»å®žä¾‹ã€‚",
        "ä¾‹å­2ï¼šå¦ä¸€ä¸ªè§’åº¦çš„è¡¥å……ä¾‹å­ã€‚"
      ],
      "knowledge_mind_map": {
        "title": "å…³äºŽ'æœ€è¿‘å‘å±•åŒº'çš„æ€ç»´å¯¼å›¾",
        "map": [
          "æœ€è¿‘å‘å±•åŒº (ZPD)",
          "  - å®šä¹‰ï¼šå„¿ç«¥çŽ°æœ‰æ°´å¹³ä¸Žæ½œåœ¨å‘å±•æ°´å¹³ä¹‹é—´çš„åŒºåŸŸ",
          "  - ä¸¤ä¸ªå…³é”®æ°´å¹³",
          "    - çŽ°æœ‰æ°´å¹³ï¼šç‹¬ç«‹è§£å†³é—®é¢˜çš„èƒ½åŠ›",
          "    - æ½œåœ¨æ°´å¹³ï¼šåœ¨æˆäººæˆ–æ›´æœ‰èƒ½åŠ›åŒä¼´å¸®åŠ©ä¸‹èƒ½è¾¾åˆ°çš„æ°´å¹³",
          "  - æ ¸å¿ƒæ€æƒ³ï¼šæ•™å­¦åº”èµ°åœ¨å‘å±•çš„å‰é¢",
          "  - æ•™è‚²å¯ç¤º",
          "    - æ­å»ºæ”¯æž¶ (Scaffolding)",
          "    - åŒä¼´äº’åŠ©å­¦ä¹ "
        ]
      }
    }
  ],
  "motivational_message": "ä¸€æ®µé¼“åŠ±çš„è¯ï¼Œå¼ºè°ƒé€šè¿‡è¿™æ ·çš„ç²¾å‡†å­¦ä¹ ï¼Œå¯ä»¥å¿«é€Ÿæ”»å…‹éš¾ç‚¹ã€‚"
}
\`\`\``;

const AI_USER_PROMPT_TEMPLATE = `è¯·ä»¥ä¸€ä½æ•™å­¦ä¸“å®¶çš„èº«ä»½ï¼Œåˆ†æžä»¥ä¸‹æ•™å¸ˆè€ƒç¼–å­¦å‘˜çš„é”™é¢˜æƒ…å†µï¼Œå¹¶ç›´æŽ¥æ•™ä¼šæˆ‘æŽŒæ¡é‚£äº›ä¸ç†Ÿæ‚‰çš„çŸ¥è¯†ç‚¹ã€‚

## é”™é¢˜ç»Ÿè®¡æ¦‚è§ˆ
- æ€»é”™é¢˜æ•°ï¼š{totalWrongQuestions}
- æ¶‰åŠç§‘ç›®ï¼š{subjects}
- é¢˜åž‹åˆ†å¸ƒï¼š{questionTypes}
- éš¾åº¦åˆ†å¸ƒï¼š{difficulties}

## è¯¦ç»†é”™é¢˜æ•°æ®
{wrongQuestionsDetails}

## ç§‘ç›®é”™è¯¯ç»Ÿè®¡
{subjectStats}

æˆ‘çš„æ ¸å¿ƒéœ€æ±‚æ˜¯ï¼š
1.  **å‘Šè¯‰æˆ‘**ï¼šæˆ‘å…·ä½“æ˜¯å“ªä¸ªå­¦ç§‘ã€å“ªä¸€ç« èŠ‚ã€å“ªä¸€ä¸ªçŸ¥è¯†ç‚¹æ²¡æŽŒæ¡ã€‚
2.  **æ•™ä¼šæˆ‘**ï¼šè¯·ç›´æŽ¥ä¸ºæˆ‘è®²è§£è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¹¶åˆ†æžæˆ‘ä¸ºä»€ä¹ˆä¼šåšé”™è¿™é“é¢˜ï¼Œå†ç”¨æ–°çš„ä¾‹å­å’Œæ€ç»´å¯¼å›¾å¸®æˆ‘å½»åº•æžæ‡‚å®ƒã€‚æˆ‘ä¸éœ€è¦å®½æ³›çš„å­¦ä¹ æ–¹æ³•å»ºè®®ã€‚

è¯·äº§å‡ºä¸€ä»½èƒ½è®©æˆ‘ç›´æŽ¥å­¦ä¹ å¹¶æŽŒæ¡çŸ¥è¯†çš„æ·±åº¦åˆ†æžæŠ¥å‘Šã€‚`;

async function testWrongQuestionsAI() {
  console.log('ðŸ§ª æµ‹è¯•é”™é¢˜AIåˆ†æžåŠŸèƒ½...\n');

  try {
    // æ¨¡æ‹Ÿé”™é¢˜æ•°æ®
    const mockWrongQuestions = `é¢˜ç›®1ï¼š
é¢˜å¹²ï¼šæ•™å­¦è¿‡ç¨‹çš„åŸºæœ¬è§„å¾‹æ˜¯ä»€ä¹ˆï¼Ÿ
é€‰é¡¹ï¼šA. ä¼ æŽˆçŸ¥è¯†ä¸Žå‘å±•æ™ºåŠ›ç›¸ç»Ÿä¸€ï¼›B. æ•™å¸ˆä¸»å¯¼ä¸Žå­¦ç”Ÿä¸»ä½“ç›¸ç»Ÿä¸€ï¼›C. æŽŒæ¡çŸ¥è¯†ä¸ŽåŸ¹å…»èƒ½åŠ›ç›¸ç»Ÿä¸€ï¼›D. ä»¥ä¸Šéƒ½æ˜¯
ç”¨æˆ·ç­”æ¡ˆï¼šA
æ­£ç¡®ç­”æ¡ˆï¼šD
ç§‘ç›®ï¼šæ•™è‚²å­¦
éš¾åº¦ï¼šå›°éš¾
é¢˜åž‹ï¼šå•é€‰é¢˜
é”™è¯¯æ¬¡æ•°ï¼š1
è§£æžï¼šæ•™å­¦è¿‡ç¨‹çš„åŸºæœ¬è§„å¾‹åŒ…æ‹¬ä¼ æŽˆçŸ¥è¯†ä¸Žå‘å±•æ™ºåŠ›ç›¸ç»Ÿä¸€ã€æ•™å¸ˆä¸»å¯¼ä¸Žå­¦ç”Ÿä¸»ä½“ç›¸ç»Ÿä¸€ã€æŽŒæ¡çŸ¥è¯†ä¸ŽåŸ¹å…»èƒ½åŠ›ç›¸ç»Ÿä¸€ç­‰ã€‚

é¢˜ç›®2ï¼š
é¢˜å¹²ï¼šçš®äºšæ°è®¤çŸ¥å‘å±•ç†è®ºä¸­ï¼Œ7-11å²å„¿ç«¥å¤„äºŽï¼Ÿ
é€‰é¡¹ï¼šA. æ„ŸçŸ¥è¿åŠ¨é˜¶æ®µï¼›B. å‰è¿ç®—é˜¶æ®µï¼›C. å…·ä½“è¿ç®—é˜¶æ®µï¼›D. å½¢å¼è¿ç®—é˜¶æ®µ
ç”¨æˆ·ç­”æ¡ˆï¼šB
æ­£ç¡®ç­”æ¡ˆï¼šC
ç§‘ç›®ï¼šæ•™è‚²å¿ƒç†å­¦
éš¾åº¦ï¼šä¸­ç­‰
é¢˜åž‹ï¼šå•é€‰é¢˜
é”™è¯¯æ¬¡æ•°ï¼š1

é¢˜ç›®3ï¼š
é¢˜å¹²ï¼šæ•™å¸ˆèŒä¸šé“å¾·çš„æ ¸å¿ƒæ˜¯ï¼Ÿ
é€‰é¡¹ï¼šA. çˆ±å²—æ•¬ä¸šï¼›B. å…³çˆ±å­¦ç”Ÿï¼›C. æ•™ä¹¦è‚²äººï¼›D. ä¸ºäººå¸ˆè¡¨
ç”¨æˆ·ç­”æ¡ˆï¼šA
æ­£ç¡®ç­”æ¡ˆï¼šB
ç§‘ç›®ï¼šèŒä¸šé“å¾·
éš¾åº¦ï¼šä¸­ç­‰
é¢˜åž‹ï¼šå•é€‰é¢˜
é”™è¯¯æ¬¡æ•°ï¼š1`;

    const userPrompt = AI_USER_PROMPT_TEMPLATE
      .replace('{totalWrongQuestions}', '3')
      .replace('{subjects}', 'æ•™è‚²å­¦ã€æ•™è‚²å¿ƒç†å­¦ã€èŒä¸šé“å¾·')
      .replace('{questionTypes}', 'å•é€‰é¢˜')
      .replace('{difficulties}', 'ä¸­ç­‰ã€å›°éš¾')
      .replace('{wrongQuestionsDetails}', mockWrongQuestions)
      .replace('{subjectStats}', 'æ•™è‚²å­¦ï¼š1é¢˜ï¼›æ•™è‚²å¿ƒç†å­¦ï¼š1é¢˜ï¼›èŒä¸šé“å¾·ï¼š1é¢˜');

    console.log('ðŸ“ æç¤ºè¯ä¿¡æ¯:');
    console.log('- ç³»ç»Ÿæç¤ºè¯é•¿åº¦:', AI_SYSTEM_PROMPT.length);
    console.log('- ç”¨æˆ·æç¤ºè¯é•¿åº¦:', userPrompt.length);

    const requestBody = {
      model: AI_CONFIG.model,
      messages: [
        { role: 'system', content: AI_SYSTEM_PROMPT },
        { role: 'user', content: userPrompt }
      ],
      max_tokens: AI_CONFIG.maxTokens,
      temperature: AI_CONFIG.temperature
    };

    console.log('\nðŸ¤– å‘é€AIåˆ†æžè¯·æ±‚...');
    const response = await fetch(AI_CONFIG.baseURL + '/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('âŒ APIè¯·æ±‚å¤±è´¥:', errorText);
      return;
    }

    const data = await response.json();
    const aiResponse = data.choices?.[0]?.message?.content;

    if (!aiResponse) {
      console.error('âŒ AIå“åº”ä¸ºç©º');
      console.error('å®Œæ•´å“åº”:', JSON.stringify(data, null, 2));
      return;
    }

    console.log('\nâœ… AIå“åº”æˆåŠŸ');
    console.log('å“åº”é•¿åº¦:', aiResponse.length);
    console.log('å“åº”å†…å®¹:');
    console.log(aiResponse);

    // å°è¯•è§£æžJSON
    try {
      const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/) || aiResponse.match(/\{[\s\S]*\}/);
      const jsonStr = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : aiResponse;
      const analysisResult = JSON.parse(jsonStr);
      
      console.log('\nðŸŽ‰ JSONè§£æžæˆåŠŸï¼');
      console.log('åˆ†æžç»“æžœç»“æž„:');
      console.log('- åˆ†æžæ¦‚è¦:', !!analysisResult.analysis_summary);
      console.log('- è–„å¼±ç‚¹è¯Šæ–­:', !!analysisResult.weakness_diagnostic);
      console.log('- æ•™å­¦è¯¾å ‚æ•°é‡:', analysisResult.targeted_tutoring_sessions?.length || 0);
      console.log('- æ¿€åŠ±ä¿¡æ¯:', !!analysisResult.motivational_message);
      
    } catch (parseError) {
      console.error('âŒ JSONè§£æžå¤±è´¥:', parseError.message);
    }

  } catch (error) {
    console.error('âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™:', error.message);
  }
}

// è¿è¡Œæµ‹è¯•
testWrongQuestionsAI().then(() => {
  console.log('\nðŸŽ‰ æµ‹è¯•å®Œæˆ!');
  process.exit(0);
}).catch(error => {
  console.error('\nðŸ’¥ æµ‹è¯•å¤±è´¥:', error);
  process.exit(1);
});
